#!/bin/bash

# Run ./lextest to test all the test cases. Use the -log option to log the failed tests

if [[ ! -d "src/main/java/antlr" ]]; then
  echo "Need to run \"make antlrBuild\" to test lexer... Exiting..."
  exit 1;
fi

mkdir test_temp
trap "{ rm -rf test_temp; }" EXIT

test ()
{
  echo "Testing: $1"
  ./grun antlr.WACC program "$1" > test_temp/output 2>&1;
  if [[ ($2 == "-valid" ) && ("$(cat test_temp/output)" != "running the ANTLR TestRig grammar tool") ]]; then
    echo "TEST FAILURE:"
    echo "Test had the following output: $(cat test_temp/output)"
    echo "$1" >> test_temp/failedfilestemp
  elif [[ ($2 == "-invalid") && ("$(cat test_temp/output)" == "running the ANTLR TestRig grammar tool") ]]; then
    echo "TEST UNEXPECTEDLY SUCCEEDED: $1"
    echo "$1" >> test_temp/failedfilestemp
  fi
}

export -f test

find testcases/valid -type f -iname '*.wacc' -exec bash -c 'test "$1" -valid' bash {} \;
find testcases/invalid -type f -iname '*.wacc' -exec bash -c 'test "$1" -invalid' bash {} \;

unset test

if [ ! -f test_temp/failedfilestemp ] ; then
  echo "All tests passed..."
  if [ "$1" == "-log" ]; then
    mkdir -p test_logs
    echo "ALL tests passed..." >> "test_logs/testfailures_$(date +%F_%R)"
  fi
  exit 0
else
  echo "The following files failed the tests: "
  cat test_temp/failedfilestemp
  if [ "$1" == "-log" ]; then
    mkdir -p test_logs
    cp test_temp/failedfilestemp "test_logs/testfailures_$(date +%F_%R)"
  fi
  exit 1
fi
